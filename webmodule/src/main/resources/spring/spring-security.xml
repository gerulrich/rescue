<?xml version="1.0" encoding="UTF-8"?>
<beans:beans 
    xmlns              = "http://www.springframework.org/schema/security"
    xmlns:beans        = "http://www.springframework.org/schema/beans"
    xmlns:xsi          = "http://www.w3.org/2001/XMLSchema-instance"
    xsi:schemaLocation = "http://www.springframework.org/schema/beans
                          http://www.springframework.org/schema/beans/spring-beans-3.1.xsd
                          http://www.springframework.org/schema/security
                          http://www.springframework.org/schema/security/spring-security-3.1.xsd">

   <global-method-security pre-post-annotations="enabled">
<!-- 		<expression-handler ref="expressionHandler"/> -->
   </global-method-security>

	
	<!-- Se debe permitir el ingreso a la página de login y los recursos (imágenes, css, etc).  -->
	<http security="none" pattern="/favicon.ico"/>
	<http security="none" pattern="/css/**"/>
	<http security="none" pattern="/img/**"/>
	<http security="none" pattern="/tiles/**"/>
	<http security="none" pattern="/static/**"/>
	<http security="none" pattern="/cloud/**"/>

   <http use-expressions="true">
<!--    		<intercept-url pattern="/**" requires-channel="https"/> -->
   
    	<intercept-url pattern="/admin/**" access="hasRole('ROLE_ADMIN')"/>
    	<!--  Para todas las otras url se debe estar autenticado. -->
        <intercept-url pattern="/**" access="isAuthenticated()" />

<!--         <form-login login-page="/login/login.html"  -->
<!-- 	        login-processing-url="/j_spring_security_check" default-target-url="/home.html"/> -->
<!--         <logout /> -->
<!-- 		<form-login login-page="/users/signin.html"/> -->
		<form-login/>
		<logout />

        <remember-me key="rescuemeApp" services-ref="rememberMeServices"/>

<!--         <custom-filter after="REMEMBER_ME_FILTER" ref="expiredSessionFilter" /> -->
		
    </http>
    

    <authentication-manager>
        <authentication-provider user-service-ref="userDetailsService">
        	<password-encoder hash="sha"/>
    	</authentication-provider>
    </authentication-manager>
    
    <beans:bean id="userDetailsService" class="net.cloudengine.service.auth.UserDetailsServiceImpl">
    	<beans:constructor-arg ref="userStore" />
    </beans:bean>
    
    
	<beans:bean id="persistentTokenRepository" class="net.cloudengine.service.auth.MongoTokenRepositoryImpl">
		<beans:constructor-arg ref="tokenStore"></beans:constructor-arg>
	</beans:bean>
	
<!--     <beans:bean id="expiredSessionFilter" class="net.cloudengine.web.servlet.ExpiredSessionFilter"/> -->


	<beans:bean id="rememberMeServices" class="org.springframework.security.web.authentication.rememberme.PersistentTokenBasedRememberMeServices">
        <beans:property name="userDetailsService" ref="userDetailsService" />
        <beans:property name="tokenRepository" ref="persistentTokenRepository" />
        <beans:property name="cookieName" value="REMEMBER_ME" />
        <beans:property name="parameter" value="remember_me" />
        <beans:property name="key" value="rescuemeApp" />
    </beans:bean>
           
</beans:beans>